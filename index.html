<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Speaking Portuguese Resources Directory and Reviews</title>

<!-- Papa Parse (CSV parser) -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{
  --green:#006600;
  --red:#d40000;
  --gold:#ffcc00;
  --ink:#222;
  --bg:#fdfdfb;
  --card-bg:#ffffff;
  --muted:#555;
  --card-border:#ddd;
  --pill-bg:#eef5ee;
}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Arial,Helvetica,sans-serif}

/* Header */
header{background:var(--green);color:#fff;padding:16px 20px;text-align:center}
h1{margin:0}

/* Container */
.wrap{max-width:1100px;margin:0 auto;padding:16px}

/* Controls (search + filters) */
.controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
.controls input,.controls select{
  padding:8px 10px;border:2px solid var(--gold);border-radius:10px;background:#fff;color:var(--ink);
}
.controls input::placeholder{color:#777}
.btn{
  display:inline-block;background:var(--red);color:#fff;border:0;border-radius:10px;
  padding:8px 12px;font-weight:700;cursor:pointer;text-decoration:none
}
.btn:hover{background:#b30000}
.btn-ghost{
  background:#fff;color:var(--ink);border:2px solid var(--gold);border-radius:10px;font-weight:700;
}
.btn-ghost:hover{background:#fff6cc}

/* Disclaimer banner */
.disclaimer{
  background:#fff8e1;               /* soft yellow */
  border:1px solid #fbc02d;          /* amber border */
  border-radius:10px;
  padding:12px 16px;
  margin:16px 0;                     /* space above/below */
  color:#444;
  font-size:.9rem;
  line-height:1.4;
}

/* Grid + card layout */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;margin-top:16px}
.card{
  background:var(--card-bg);border:1px solid var(--card-border);border-left:6px solid var(--green);
  border-radius:10px;padding:14px;box-shadow:0 2px 6px rgba(0,0,0,.08);
}
.name{font-size:18px;font-weight:700;margin:2px 0 6px;color:var(--green)}
.meta{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 10px}
.pill{background:var(--pill-bg);border:1px solid #cfe5cf;color:#224622;border-radius:999px;padding:3px 10px;font-size:12px}
.pill--alert{background:#ffecec;border-color:#f2b3b3;color:#8a0000}
.row{display:flex;align-items:center;gap:10px;margin:6px 0}
.stars{color:var(--gold);font-weight:700}
.muted{color:var(--muted)}
.small{font-size:12px}

/* Teaser notes (2 lines + fade) */
.notes{
  margin-top:6px;color:var(--muted);
  display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
  overflow:hidden;position:relative;min-height:2.2em;
}
.notes::after{
  content:"";position:absolute;right:0;bottom:0;height:1.4em;width:35%;
  background:linear-gradient(to right, rgba(255,255,255,0), var(--card-bg));
}

a{color:var(--green)}

/* Footer count */
footer#count{margin-top:12px;color:var(--muted);text-align:left}

/* Modal */
.modalOverlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999}
.modal{background:#fff;border:3px solid var(--green);border-radius:12px;max-width:760px;width:100%;max-height:80vh;display:flex;flex-direction:column}
.modal header{background:var(--green);color:#fff;padding:12px 14px;text-align:left}
.modal .content{padding:14px;overflow:auto}
.review{background:#fafafa;border:1px solid #e5e5e5;border-radius:10px;padding:10px;margin:10px 0}
.review .by{font-weight:700}
.close{background:transparent;border:0;color:#fff;font-size:22px;cursor:pointer;float:right}

/* Posted by spacing & tone */
.posted-by{
  font-size:.85em;
  color:#777;          /* lighter = metadata */
  margin-top:8px;      /* space from description */
  margin-bottom:12px;  /* space before button */
  display:block;
}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Speaking Portuguese Resources Directory</h1>
    <div class="controls">
      <input id="q" placeholder="Search name, notes…" />
      <select id="type"><option value="">All types</option></select>
      <select id="level"><option value="">All levels</option></select>
      <button class="btn-ghost" id="clearBtn" aria-label="Clear filters">Clear filters</button>
    </div>
  </header>

  <!-- Disclaimer (subtle banner) -->
  <div class="disclaimer" role="note">
    DISCLAIMER - All reviews and information posted here are based on personal experiences of members of Porto Together's Speaking Portuguese group and should be provided in good faith. Other experiences may vary. Use these reviews and information at your own risk.
  </div>

  <div id="grid" class="grid" aria-live="polite"></div>
  <footer id="count" class="muted"></footer>
</div>

<!-- Modal -->
<div id="modalOverlay" class="modalOverlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal">
    <header>
      <h2 id="modalTitle">Details</h2>
      <button class="close" aria-label="Close" onclick="closeModal()">✕</button>
    </header>
    <div class="content">
      <div id="reviewsContainer"></div>
    </div>
  </div>
</div>

<script>
/* ======= 1) YOUR PUBLISHED CSV LINKS ======= */
const DIRECTORY_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFCkif4UxnvMNS5cwza23gYx0LioKINM7GvvnpIIBdeUHzR-2ktwFXKcluyzsYhUoDCctm67Y1hSRF/pub?gid=0&single=true&output=csv";
const REVIEWS_CSV   = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFCkif4UxnvMNS5cwza23gYx0LioKINM7GvvnpIIBdeUHzR-2ktwFXKcluyzsYhUoDCctm67Y1hSRF/pub?gid=979754207&single=true&output=csv";
/* =========================================== */

const state = {
  directory: [],     // one row per resource
  byId: {},          // resource_id -> resource row
  reviews: {},       // resource_id -> [reviews]
  filtered: []
};

function csvToObjects(csv) {
  const res = Papa.parse(csv.trim(), { header: true, skipEmptyLines: true });
  return res.data;
}

async function fetchCSV(url) {
  const r = await fetch(url, { cache: "no-store" });
  if (!r.ok) throw new Error("Failed to fetch " + url);
  return await r.text();
}

function buildReviewMap(rows) {
  const byId = {};
  rows.forEach(r => {
    const id = (r.resource_id || "").trim();
    if (!id) return;
    (byId[id] ||= []).push(r);
  });
  Object.values(byId).forEach(list => {
    list.sort((a,b)=> new Date(b.submitted_at||0) - new Date(a.submitted_at||0));
  });
  return byId;
}

function uniqSorted(list) {
  return [...new Set(list.filter(Boolean))].sort();
}

function initFilters() {
  const typeSel = document.getElementById("type");
  const levelSel = document.getElementById("level");
  const types = uniqSorted(state.directory.map(r=>r.Type));
  const levels = uniqSorted(state.directory.map(r=>r.Level));
  types.forEach(t => typeSel.insertAdjacentHTML("beforeend", `<option>${t}</option>`));
  levels.forEach(l => levelSel.insertAdjacentHTML("beforeend", `<option>${l}</option>`));
  ["q","type","level"].forEach(id => document.getElementById(id).addEventListener("input", applyFilters));
  document.getElementById("clearBtn").addEventListener("click", clearFilters);
}

function applyFilters() {
  const q = document.getElementById("q").value.toLowerCase().trim();
  const t = document.getElementById("type").value;
  const l = document.getElementById("level").value;
  state.filtered = state.directory.filter(r => {
    const textBlob = `${r.Name||""} ${r.Notes||""} ${r.Modalities||""} ${r.Location||""}`.toLowerCase();
    return (!t || r.Type===t) &&
           (!l || r.Level===l) &&
           (!q || textBlob.includes(q));
  });
  renderCards();
}

function clearFilters(){
  document.getElementById("q").value = "";
  document.getElementById("type").value = "";
  document.getElementById("level").value = "";
  applyFilters();
}

function stars(x) {
  const n = Number(x||0);
  if (!n) return "—";
  return n.toFixed(1);
}

function isUrl(s){
  if(!s) return false;
  try {
    const u = new URL(s);
    return u.protocol === "http:" || u.protocol === "https:" || u.protocol === "mailto:" || u.protocol === "tel:";
  } catch { return false; }
}

/* normalize truthy self flags */
function toBoolSelf(v){
  if (!v) return false;
  const s = String(v).toLowerCase().trim();
  return s === 'yes' || s === 'true' || s === '1' || s.includes('(self)') || s === 'self';
}

function renderCards() {
  const grid = document.getElementById("grid");
  const count = document.getElementById("count");
  grid.innerHTML = "";
  state.filtered.forEach(r => {
    const reviewsCount = Number(r.Reviews||0);
    const contact = r["Contact URL"];
    const contactHtml = (contact && isUrl(contact))
      ? `<div style="margin-top:8px"><a href="${contact}" target="_blank" rel="noopener">Contact / Website ↗</a></div>`
      : "";

    const postedByLine = r.PostedBy
      ? `Posted by: ${r.PostedBy}${r.SelfFlag ? " (self)" : ""}`
      : "";

    const metaHtml = `
      <div class="meta">
        ${r.Type ? `<div class="pill">${r.Type}</div>` : ""}
        ${r.Level ? `<div class="pill">Level: ${r.Level}</div>` : ""}
        ${r.Location ? `<div class="pill">${r.Location}</div>` : ""}
        ${r.SelfFlag ? `<div class="pill pill--alert">Self-promo</div>` : ""}
      </div>
    `;

    const card = `
      <div class="card">
        <div class="name">${r.Name||""}</div>
        ${metaHtml}
        <div class="row">
          <span class="stars">★ ${stars(r["Avg Rating"])}</span>
          <span class="muted">(${reviewsCount} review${reviewsCount===1?"":"s"})</span>
        </div>
        ${r.Modalities ? `<div class="muted">${r.Modalities}</div>` : ""}
        <div class="notes">${r.Notes ? r.Notes : ""}</div>
        ${postedByLine ? `<span class="posted-by">${postedByLine}</span>` : ""}
        <a class="btn" href="#" onclick="openDetails('${encodeURIComponent(r.resource_id)}');return false;">View details & reviews</a>
        ${contactHtml}
      </div>`;
    grid.insertAdjacentHTML("beforeend", card);
  });
  count.textContent = `${state.filtered.length} resource${state.filtered.length===1?"":"s"} shown`;
}

function openDetails(resourceIdEnc){
  const resourceId = decodeURIComponent(resourceIdEnc);
  const r = state.byId?.[resourceId];
  const list = state.reviews[resourceId] || [];

  const container = document.getElementById("reviewsContainer");
  const title = r?.Name || "Details";
  document.getElementById("modalTitle").textContent = title;
  container.innerHTML = "";

  if (r){
    const contact = r["Contact URL"];
    const contactHtml = contact
      ? (isUrl(contact)
          ? `<a href="${contact}" target="_blank" rel="noopener">Contact / Website ↗</a>`
          : `<span class="muted">Contact: ${contact}</span>`)
      : "";

    const postedByLine = r.PostedBy
      ? `Posted by: ${r.PostedBy}${r.SelfFlag ? " (self)" : ""}`
      : "";

    const chipsHtml = `
      <div class="muted" style="margin:4px 0">
        ${r.Type ? `<span class="pill">${r.Type}</span>&nbsp;` : ""}
        ${r.Level ? `<span class="pill">Level: ${r.Level}</span>&nbsp;` : ""}
        ${r.Location ? `<span class="pill">${r.Location}</span>&nbsp;` : ""}
        ${r.SelfFlag ? `<span class="pill pill--alert">Self-promo</span>` : ""}
      </div>
    `;

    container.insertAdjacentHTML("beforeend", `
      <div style="margin-bottom:12px">
        <div class="row" style="margin:0 0 6px"><span class="stars">★ ${stars(r["Avg Rating"])}</span>
          <span class="muted">&nbsp;(${Number(r.Reviews||0)} review${Number(r.Reviews||0)===1?"":"s"})</span>
        </div>
        ${chipsHtml}
        ${r.Modalities ? `<div class="muted" style="margin:6px 0">${r.Modalities}</div>` : ""}
        ${r.Notes ? `<div style="margin:6px 0">${r.Notes}</div>` : ""}
        ${postedByLine ? `<div class="muted" style="margin:6px 0">${postedByLine}</div>` : ""}
        ${contactHtml ? `<div style="margin:6px 0">${contactHtml}</div>` : ""}
        <hr style="border:none;border-top:1px solid #e5e5e5;margin:12px 0">
      </div>
    `);
  }

  container.insertAdjacentHTML("beforeend", `<h3 style="margin:0 0 8px">Reviews</h3>`);
  if (!list.length) {
    container.insertAdjacentHTML("beforeend", `<div class="empty">No reviews yet.</div>`);
  } else {
    list.forEach(rv => {
      const when = rv.submitted_at ? new Date(rv.submitted_at) : null;
      const dateStr = when ? when.toLocaleDateString(undefined, {year:'numeric', month:'short', day:'numeric'}) : "";
      container.insertAdjacentHTML("beforeend", `
        <div class="review">
          <div class="by">★ ${rv.rating || rv.rating_1_to_5 || "—"} — ${rv.reviewer || "Anonymous"}</div>
          ${dateStr ? `<div class="muted" style="font-size:12px">${dateStr}</div>` : ""}
          <div style="margin-top:4px">${(rv.review_text||"").replace(/\n/g,"<br>")}</div>
        </div>
      `);
    });
  }

  const overlay = document.getElementById("modalOverlay");
  overlay.style.display = "flex";
  overlay.setAttribute("aria-hidden", "false");
}

function closeModal(){
  const overlay = document.getElementById("modalOverlay");
  overlay.style.display = "none";
  overlay.setAttribute("aria-hidden", "true");
}

async function main() {
  try {
    const [dirCSV, revCSV] = await Promise.all([fetchCSV(DIRECTORY_CSV), fetchCSV(REVIEWS_CSV)]);
    const dirRows = csvToObjects(dirCSV);
    const revRows = csvToObjects(revCSV);

    // Normalize + derive flags
    state.directory = dirRows.map(r => {
      const postedByRaw =
        r.posted_by || r.Posted_by || r["Posted By"] || r.postedBy || r.PostedBy || "";

      const selfRaw  = r.self || r.posted_by_self || r.self_flag || r.Self || r["Self?"] || "";
      const selfFromText = /\(self\)/i.test(String(postedByRaw));
      const selfFlag = toBoolSelf(selfRaw) || selfFromText;

      const postedByClean = String(postedByRaw).replace(/\s*\(self\)\s*/ig, '').trim();

      return {
        resource_id: r.resource_id || r.Resource_ID || r.id || "",
        Name:        r.Name || r.name_title || r.Title || "",
        Type:        r.Type || r.type || "",
        Level:       r.Level || r.level || "",
        "Avg Rating":r["Avg Rating"] || r.avg_rating || "",
        Reviews:     r.Reviews || r.num_reviews || "",
        Modalities:  r.Modalities || r.modalities || "",
        Location:    r.Location || r.location || "",
        "Contact URL": r["Contact"] || r["Contact URL"] || r.contact_url || "",
        Notes:       r.Notes || r.notes || "",
        PostedBy:    postedByClean,
        SelfFlag:    !!selfFlag
      };
    }).filter(r => r.resource_id && r.Name);

    /* Sort alphabetically by Name (A→Z) */
    state.directory.sort((a,b) => a.Name.localeCompare(b.Name, undefined, {sensitivity:'base'}));

    state.byId = Object.fromEntries(state.directory.map(r => [r.resource_id, r]));
    state.reviews = buildReviewMap(revRows);

    initFilters();
    state.filtered = state.directory.slice();   // starts sorted
    renderCards();
  } catch (err) {
    document.getElementById("grid").innerHTML = `<div class="muted">Error loading data: ${err.message}</div>`;
    console.error(err);
  }
}

main();
</script>
</body>
</html>
